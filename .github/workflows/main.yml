name: MLOps CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DOCKER_IMAGE: mlops-fakenews

jobs:
  # Job 1: Lint and Code Quality
  lint:
    runs-on: ubuntu-latest
    name: Code Quality
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install linting tools
      run: |
        pip install flake8 black isort
        
    - name: Run Black (check only)
      run: |
        black --check src/ tests/ prefect_flows/ || true
      continue-on-error: true
        
    - name: Run isort (check only)
      run: |
        isort --check-only src/ tests/ prefect_flows/ || true
      continue-on-error: true
        
    - name: Create flake8 config
      run: |
        cat > .flake8 << 'EOF'
        [flake8]
        max-line-length = 120
        extend-ignore = E203, W503
        exclude = 
            .git,
            __pycache__,
            .venv,
            venv,
            build,
            dist
        EOF
        
    - name: Run Flake8
      run: |
        flake8 src/ tests/ || true
      continue-on-error: true

  # Job 2: Run Tests
  test:
    runs-on: ubuntu-latest
    name: Unit Tests
    needs: lint
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-mock
        pip install pandas scikit-learn
        
    - name: Create directories
      run: |
        mkdir -p artifacts data logs
        
    - name: Run tests
      run: |
        if [ -f tests/test_basic.py ]; then
          pytest tests/test_basic.py -v --tb=short
        else
          echo "No tests found, skipping..."
          exit 0
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          .pytest_cache/
          artifacts/
        if-no-files-found: ignore

  # Job 3: Build Docker Images
  build:
    runs-on: ubuntu-latest
    name: Build Docker
    needs: test
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Check if Dockerfile exists
      id: check_dockerfile
      run: |
        if [ -f Dockerfile ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Build ML App Image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        docker images
        
    - name: Test Docker image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker run --rm ${{ env.DOCKER_IMAGE }}:latest python --version
        
    - name: Save Docker image
      if: steps.check_dockerfile.outputs.exists == 'true'
      run: |
        docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > mlops-image.tar.gz
        
    - name: Upload Docker image artifact
      if: steps.check_dockerfile.outputs.exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: mlops-image.tar.gz
        retention-days: 7
        
    - name: Skip Docker build
      if: steps.check_dockerfile.outputs.exists == 'false'
      run: |
        echo "‚ö†Ô∏è No Dockerfile found, skipping Docker build"

  # Job 4: Integration Test with Services
  integration-test:
    runs-on: ubuntu-latest
    name: Integration Tests
    needs: build
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Create test data
      run: |
        mkdir -p data
        cat > data/fake_news.csv << 'EOF'
        title,text,label
        "Breaking News","This is fake news content for testing",1
        "Real Story","This is real news content for testing",0
        "Update","Another fake news article for testing",1
        "Report","Another real news article for testing",0
        EOF
        
    - name: Check if docker-compose exists
      id: check_compose
      run: |
        if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Start MLflow service
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        docker-compose up -d mlflow || echo "MLflow service not found in docker-compose"
      continue-on-error: true
        
    - name: Wait for MLflow
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:5000/health 2>/dev/null; do sleep 2; done' || echo "MLflow not available"
      continue-on-error: true
        
    - name: Check MLflow is running
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl http://localhost:5000/health || echo "MLflow health check failed"
      continue-on-error: true
        
    - name: Stop services
      if: always() && steps.check_compose.outputs.exists == 'true'
      run: |
        docker-compose logs mlflow || true
        docker-compose down -v || true
        
    - name: Skip integration tests
      if: steps.check_compose.outputs.exists == 'false'
      run: |
        echo "‚ö†Ô∏è No docker-compose file found, skipping integration tests"

  # Job 5: Start Full Stack
  deploy-test:
    runs-on: ubuntu-latest
    name: Full Stack Test
    needs: integration-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Create test data
      run: |
        mkdir -p data
        cat > data/fake_news.csv << 'EOF'
        title,text,label
        "Breaking News","This is fake news content",1
        "Real Story","This is real news content",0
        EOF
        
    - name: Check if docker-compose exists
      id: check_compose
      run: |
        if [ -f docker-compose.yml ] || [ -f docker-compose.yaml ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Start all services
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        docker-compose up -d
        
    - name: Wait for services
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        echo "‚è≥ Waiting for services to start..."
        sleep 30
        
    - name: Check MLflow
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl -f http://localhost:5000/health || echo "‚ö†Ô∏è MLflow not ready"
      continue-on-error: true
        
    - name: Check Prefect
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl -f http://localhost:4200/api/health || echo "‚ö†Ô∏è Prefect not ready"
      continue-on-error: true
        
    - name: Check ML App
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl -f http://localhost:8080/health || echo "‚ö†Ô∏è ML App not ready"
      continue-on-error: true
        
    - name: Check Prometheus
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl -f http://localhost:9090/-/healthy || echo "‚ö†Ô∏è Prometheus not ready"
      continue-on-error: true
        
    - name: Check Grafana
      if: steps.check_compose.outputs.exists == 'true'
      run: |
        curl -f http://localhost:3000/api/health || echo "‚ö†Ô∏è Grafana not ready"
      continue-on-error: true
        
    - name: Show service logs
      if: always() && steps.check_compose.outputs.exists == 'true'
      run: |
        echo "=== MLflow Logs ==="
        docker-compose logs --tail=50 mlflow || true
        echo "=== Prefect Server Logs ==="
        docker-compose logs --tail=50 prefect || true
        echo "=== ML App Logs ==="
        docker-compose logs --tail=50 ml-app || true
        
    - name: Stop all services
      if: always() && steps.check_compose.outputs.exists == 'true'
      run: |
        docker-compose down -v
        
    - name: Skip full stack test
      if: steps.check_compose.outputs.exists == 'false'
      run: |
        echo "‚ö†Ô∏è No docker-compose file found, skipping full stack tests"

  # Job 6: Security Scan
  security:
    runs-on: ubuntu-latest
    name: Security Scan
    needs: build
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Check for Docker image artifact
      id: check_artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
      continue-on-error: true
        
    - name: Load Docker image
      if: steps.check_artifact.outcome == 'success'
      run: |
        docker load < mlops-image.tar.gz
        
    - name: Run Trivy vulnerability scanner
      if: steps.check_artifact.outcome == 'success'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_IMAGE }}:latest
        format: 'table'
        exit-code: '0'
        ignore-unfixed: true
        severity: 'CRITICAL,HIGH'
      continue-on-error: true
      
    - name: Skip security scan
      if: steps.check_artifact.outcome != 'success'
      run: |
        echo "‚ö†Ô∏è No Docker image found, skipping security scan"

  # Job 7: Deploy to Production (Manual)
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to Production
    needs: [test, build, integration-test, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Check for Docker image artifact
      id: check_artifact
      uses: actions/download-artifact@v4
      with:
        name: docker-image
      continue-on-error: true
        
    - name: Deployment notification
      run: |
        echo "üöÄ Deploying to production environment"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        
    - name: Simulate deployment
      run: |
        echo "In a real scenario, this would:"
        echo "1. Push Docker image to registry"
        echo "2. SSH to production server"
        echo "3. Pull latest images"
        echo "4. Run docker-compose up with production config"
        echo "5. Run health checks"
        echo "6. Send notifications"

  # Summary Job
  ci-cd-summary:
    runs-on: ubuntu-latest
    name: CI/CD Summary
    needs: [lint, test, build, integration-test, security]
    if: always()
    
    steps:
    - name: Print summary
      run: |
        echo "==================================="
        echo "‚úÖ CI/CD Pipeline Execution Summary"
        echo "==================================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Workflow: ${{ github.workflow }}"
        echo "Run Number: ${{ github.run_number }}"
        echo "==================================="
        echo "üìù Lint: ${{ needs.lint.result }}"
        echo "üß™ Test: ${{ needs.test.result }}"
        echo "üê≥ Build: ${{ needs.build.result }}"
        echo "üîó Integration: ${{ needs.integration-test.result }}"
        echo "üîí Security: ${{ needs.security.result }}"
        echo "==================================="
